<!DOCTYPE html>
<html lang="">
  <head>
    <meta charset="utf-8" />
    <title>James Lowther - View</title>
    <script src="dino.js"></script>
    <script src="ship.js"></script>
    <script src="statue.js"></script>
    <script src="skull.js"></script>
    <script src="iss.js"></script>
    <link
      href="https://unpkg.com/tailwindcss@^1.0/dist/tailwind.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="bg-black" onresize="set_dimensions()">
    <div class="flex fixed">
      <a class="text-white mt-5 shadow-lg transition duration-300 ease-in-out bg-gray-700 hover:bg-white hover:text-black transform hover:-translate-y-1 hover:scale-105 rounded-lg py-1 px-8 m-6 opacity-75" href="index.html">Back</a>
    </div>
    <div class="flex flex-row justify-between items-center px-10 z-50">
      <button onclick="prev()" class="transform hover:-translate-x-1 my-16 w-16 opacity-75">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="grey">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 15l-3-3m0 0l3-3m-3 3h8M3 12a9 9 0 1118 0 9 9 0 01-18 0z" />
        </svg>
      </button>
      <div class="flex justify-center items-center w-full h-screen z-0">
        <canvas id="ascii">
          Your browser does not support the HTML5 canvas tag.
        </canvas>
      </div>
      <button onclick="next()" class="transform hover:translate-x-1 my-16 w-16 opacity-75">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="grey">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 9l3 3m0 0l-3 3m3-3H8m13 0a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      </button>
    </div>

    <script>
      var animations = [dino, ship, statue, skull, iss];
      var c_index = 0;

      var canvas_id = "ascii";

      var frame_time = 1000;
      var squishiness = 2;

      var num_frames = null;
      var frame_x = null;
      var frame_y = null;
      var pixel_size = null;

      var red = ["0", "36", "72", "109", "145", "182", "218", "255"];
      var green = ["0", "36", "72", "109", "145", "182", "218", "255"];
      var blue = ["0", "85", "170", "255"];

      function prev() {
        c_index = c_index - 1;
        if (c_index < 0) {
          c_index = animations.length - 1;
        }
      }

      function next() {
        c_index = (c_index + 1) % animations.length;
      }

      function sleep(milliseconds) {
        return new Promise((resolve) => setTimeout(resolve, milliseconds));
      }

      function set_dimensions() {
        num_frames = animations[c_index].length;
        frame_x = Math.floor(animations[c_index][0][0].length / 3);
        frame_y = animations[c_index][0].length;
        pixel_size = null;

        let c = document.getElementById(canvas_id);
        let ctx = c.getContext("2d");

        let width = c.parentElement.offsetWidth - 5;
        let height = c.parentElement.offsetHeight - 5;

        if (width >= height) {
          pixel_size = height / frame_y;
          if (pixel_size * frame_x - squishiness * frame_x > width) {
            pixel_size = width / frame_x;
            ctx.canvas.width = width - squishiness * frame_x;
            ctx.canvas.height = pixel_size * frame_y;
          } else {
            ctx.canvas.width = pixel_size * frame_x - squishiness * frame_x;
            ctx.canvas.height = height;
          }
        } else {
          pixel_size = width / frame_x;
          ctx.canvas.width = width - squishiness * frame_x;
          ctx.canvas.height = pixel_size * frame_y;
        }
      }

      async function start() {
        while (true) {
          console.log("Starting animation");
          set_dimensions();
          await loop();
        }
      }

      function convert_color(str_hex) {
        let color_int = parseInt("0x" + str_hex);

        let color =
          "rgb(" +
          red[(color_int & 0xe0) >> 5] +
          "," +
          green[(color_int & 0x1c) >> 2] +
          "," +
          red[color_int & 0x03] +
          ")";

        return color;
      }

      async function loop() {
        let c = document.getElementById(canvas_id);
        let ctx = c.getContext("2d");

        let index = c_index;

        for (i = 0; i < num_frames; i++) {
          ctx.font = pixel_size.toString() + "px Courier New";
          ctx.clearRect(0, 0, c.width, c.height);
          for (j = 0; j < frame_y; j++) {
            let line = animations[c_index][i][j];
            for (l = 0; l < frame_x; l++) {
              let start = l * 3;
              ctx.fillStyle = convert_color(line.slice(start + 1, start + 3));
              ctx.fillText(
                line[start],
                l * (pixel_size - squishiness) + 2,
                pixel_size + j * pixel_size
              );
            }
          }
          if (index != c_index) break;
          await sleep(frame_time);
        }
      }
      start();
    </script>
  </body>
</html>
